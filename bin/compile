#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# used for inline heroku buildpack

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

PROJECT_PATH=src

echo "-----> Sub-directory buildpack: path is $PROJECT_PATH"
echo "       creating cache: $CACHE_DIR"
mkdir -p $CACHE_DIR
TMP_DIR=`mktemp -d $CACHE_DIR/dummyXXXXX`
echo "       created tmp dir: $TMP_DIR"

echo "       moving working dir: $PROJECT_PATH to $TMP_DIR"
cp -R $BUILD_DIR/$PROJECT_PATH/. $TMP_DIR/

echo "       making gem directory to contain source"
GEM_DIR=`mktemp -d $CACHE_DIR/ice_cube-selectXXXXX`
cp -R $BUILD_DIR/. $GEM_DIR/

echo "       cleaning build dir $BUILD_DIR"
rm -rf $BUILD_DIR
echo "       recreating $BUILD_DIR"
mkdir -p $BUILD_DIR

echo "       copying work dir from cache $TMP_DIR to build dir $BUILD_DIR"
cp -R $TMP_DIR/. $BUILD_DIR/

echo "       making the vendor/ice_cube-select directory"
mkdir -p $BUILD_DIR/vendor/ice_cube-select

echo "       moving $GEM_DIR into the vendor directory"
cp -R $GEM_DIR/. $BUILD_DIR/vendor/ice_cube-select/

echo "       cleaning tmp dir $TMP_DIR"
rm -rf $TMP_DIR

echo "       Switching to Gemfile.deploy as a base"
\cp Gemfile.deploy Gemfile
exit 0
